

Bitmap(也称为位数组或者位向量等)是一种实现对位的操作的'数据结构'，在数据结构加引号主要因为：
- Bitmaps 本身不是一种数据结构，实际上就是字符串，但是可以对字符串进行位操作。
- Bitmaps 单独提供了一套命令，所以与使用字符串的方法不太相同。可以把 Bitmaps 想象成一个以位为单位的数组，数组的每个单元只能存储 0 和 1，数组的下标在 Bitmaps 中叫做偏移量。

Redis 是一个内存数据结构服务器，提供了对位操作的支持。然而，在 Redis 中 Bitmaps 并不是一个特殊的数据结构。相反，位操作在基本的 Redis 结构 String 上是支持的。现在，Redis 字符串的最大长度是 512 MB。因此，Redis 可以转换为 Bitmap 的最大域是 232 (512 MB = 229 bytes = 232 bits)。


## 2. 命令

本节将每个独立用户是否访问过网站存放在Bitmaps中，将访问的用户记做1，没有访问的用户记做0，用偏移量作为用户的id。

### 2.1 SETBIT

> 最早可用版本：2.2.0。时间复杂度：O(1)。

语法格式：
```
SETBIT KEY OFFSET VALUE
```

SETBIT 用来设置 KEY 对应第 OFFSET 位的值（OFFSET 从 0 开始算），可以设置为 0 或者 1。当指定的 KEY 不存在时，会自动生成一个新的字符串值。字符串会进行扩展以确保可以将 VALUE 保存在指定的偏移量 OFFSET 上。当字符串值进行扩展时，空白位置用 0 来填充。需要注意的是 OFFSET 需要大于或等于 0，小于 2 的 32 次方(即 Bitmap 上限为 512 MB，因为 Redis 字符串的最大长度是 512 MB)。

> 当设置最后一个 bit 位（偏移量等于 2^32 -1）并且存储在 key 的字符串值还没有创建，或者只保存了一个小的字符串值时，Redis 需要分配所需要的所有内存，这会阻塞服务器的一段时间。在 2010 款 MacBook Pro 上，设置第 2^32 -1 位（需要分配 512MB 内存）大约需要 300 毫秒，设置第 2^30 -1 位（128 MB）大约需要 80 毫秒，设置第 2^28 -1 位（32MB）需要约 30 毫秒，设置第 2^26 -1（8MB）需要约 8 毫秒。一旦完成第一次分配，随后对同一 KEY 的 SETBIT 调用将不会产生分配开销。

假设现在有 10 个用户，uid 为 0、1、5、9 的 4 个用户对网站进行了访问，那么当前 Bitmaps 初始化结果如下图所示：

![]()

具体操作过程如下，uv:20220514 代表 20220514 这天的所有访问用户的 Bitmaps：
```
127.0.0.1:6379> setbit uv:20220514 0 1
(integer) 0
127.0.0.1:6379> setbit uv:20220514 5 1
(integer) 0
127.0.0.1:6379> setbit uv:20220514 11 1
(integer) 0
127.0.0.1:6379> setbit uv:20220514 15 1
(integer) 0
127.0.0.1:6379> setbit uv:20220514 19 1
(integer) 0
```


如果此时有一个userid=50的用户访问了网站，那么Bitmaps的结构变成了图3-12，第20位~49位都是0。
图3-12 userid=50用户访问
很多应用的用户id以一个指定数字（例如10000）开头，直接将用户id和Bitmaps的偏移量对应势必会造成一定的浪费，通常的做法是每次做setbit操作时将用户id减去这个指定数字。在第一次初始化Bitmaps时，假如偏移量非常大，那么整个初始化过程执行会比较慢，可能会造成Redis的阻塞。
2.获取值
gitbit key offset
获取键的第offset位的值（从0开始算），下面操作获取id=8的用户是否在2016-04-05这天访问过，返回0说明没有访问过：
127.0.0.1:6379> getbit unique:users:2016-04-05 8
(integer) 0
由于offset=1000000根本就不存在，所以返回结果也是0：
127.0.0.1:6379> getbit unique:users:2016-04-05 1000000
(integer) 0
3.获取Bitmaps指定范围值为1的个数
bitcount [start][end]
下面操作计算2016-04-05这天的独立访问用户数量：
127.0.0.1:6379> bitcount unique:users:2016-04-05
(integer) 5
[start]和[end]代表起始和结束字


原文:[Introduction to Redis Data Structures: Bitmaps](https://scalegrid.io/blog/introduction-to-redis-data-structure-bitmaps/)
