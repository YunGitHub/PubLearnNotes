## 1. 背景

我们上下班经常会用APP打车和共享单车，下面2张图，应该都很熟悉，打开定位，查找我附近的车，那么，这个是怎么实现的呢？
我脑海中第一个实现方式是：实时上报经纬度。在数据库里，把经纬度都标记为索引，通过查找对比经纬度的值，来找到附近1km的车子，但是这种做法第一是索引比较多，数值比较大，二是需要循环遍历经纬度，查询会很慢，效率很低。

那么，这些 APP 是怎么做到，既能精准定位，又能快速查找呢？答案就是 GeoHash。

## 2. 什么是 GeoHash

### 2.1 经纬度

了解什么是 GeoHash 原理之前，我们先来简单看一下什么是经纬度，这对于理解 GeoHash 有很大的帮助。我们将地球铺平开来，会得到下面这个平面图：

![]()

以赤道和本初子午线为界来划分经度和纬度，赤道和本初子午线均在 0 度。经度是指通过某地的经线面与本初子午面所成的二面角。从本初子午线向东划分 180 度称为东经，用 'E' 表示：`(0, 180]`；向西划分 180 度称为西经，用 'W' 表示：`[-180, 0)`：

![]()

纬度是指过椭球面上某点作法线，该点法线与赤道平面的线面角。以赤道向北划分 90 度称为北纬，用 'N' 表示：`(0, 90]`；向南划分 90 度称为南纬，用 'S' 表示：`[-90, 0)`：

![]()

> 纬线和纬线是角度数值，并不是米。

因此我们常用十字坐标法来表示经纬度坐标图，以赤道作为经度 X 横坐标，以本初子午线作为纬度 Y 竖坐标：

![]()

一个经度和一个纬度唯一确定了地球上的一个地点的精确位置。比如北京首都国际机场的定位就是：(40.08118559489892, 116.60367893736044）表示的是：纬度=40.08118559489892，经度=116.60367893736044：

![]()

### 2.2 GeoHash

在了解什么是经纬度之后，现在我们来说一下什么是 GeoHash。GeoHash 是一种对地理坐标进行编码的方法，将二维坐标映射为一个字符串。每个字符串代表一个特定的矩形，在该矩形范围内的所有坐标都共用这个字符串。字符串越长精度越高，对应的矩形范围越小。

## 3. 实现原理

对一个地理坐标实现 GeoHash 编码时，需要通过如下步骤实现将一个经纬度坐标转换成一个 GeoHash 编码字符串：
- 指定一个位置的经纬度坐标值，将纬度和经度分别划分成1和0的二进制数字串；
- 按照'偶数位放经度，奇数位放纬度'的原则，将得到的二进制编码穿插组合，得到一个新的二进制串；
- 合并后的二进制串，按照从前往后，每隔 5 位，换算成十进制数字，最后不足 5 位的用 0 补齐；
- 最后，根据 base32 的对照表，将十进制数字翻译成字符串，即得到地理坐标对应的目标 GeoHash 字符串

对一个地理坐标编码时，按照初始区间范围纬度[-90,90]和经度[-180,180]，计算目标经度和纬度分别落在左区间还是右区间。落在左区间则取0，右区间则取1。然后，对上一步得到的区间继续按照此方法对半查找，得到下一位二进制编码。当编码长度达到业务的进度需求后，根据“偶数位放经度，奇数位放纬度”的规则，将得到的二进制编码穿插组合，得到一个新的二进制串。最后，根据base32的对照表，将二进制串翻译成字符串，即得到地理坐标对应的目标GeoHash字符串。




以坐标 '40.08118559489892, 116.60367893736044' 为例，计算其 GeoHash 字符串。首先对纬度做二进制编码：
- 将 `[-90,90]` 平分为 2 部分，纬度 '40.08118559489892' 落在右区间 `(0,90]`，则第一位取 1;
- 将 `(0,90]` 平分为 2 部分，纬度落在左区间 `(0,45]`，则第二位取 0;
- 不断重复以上步骤，得到的目标区间会越来越小，区间的两个端点也越来越逼近 '30.280245';

下图的流程详细地描述了前几次迭代的过程：

![](1)

以哈希值`ezs42`为例，这里是如何解码为十进制的经度和纬度。

第一步是使用以下字符映射从32位解码：


该操作产生`01101 11111 11000 00100 00010`。假设在左侧从0开始计数，偶数位取经度码（0111110000000），而奇数位取纬度码（101111001001）。


### 3.1 根据经纬度计算GeoHash二进制编码


40.08118559489892

纬度:

编码|区间下限|中间点|区间上限
---|---|---|---
1|-90.0|0.0|90.0
0|0.0|45.0|90.0
1|0.0|22.5|45.0
1|22.5|33.75|45.0
1|33.75|39.375|45.0
0|39.375|42.1875|45.0
0|39.375|40.78125|42.1875
1|39.375|40.078125|40.78125
0|40.078125|40.4296875|40.78125
0|40.078125|40.25390625|40.4296875

经度:

编码|区间下限|中间点|区间上限
---|---|---|---
1|-180.0|0.0|180.0
1|0.0|90.0|180.0
0|90.0|135.0|180.0
1|90.0|112.5|135.0
0|112.5|123.75|135.0
0|112.5|118.125|123.75
1|112.5|115.3125|118.125
0|115.3125|116.71875|118.125
1|115.3125|116.015625|116.71875
1|116.015625|116.3671875|116.71875


纬度:40.081419
编码二进制:1011100100
经度:
编码二进制:1101001011







[一种基于快速GeoHash实现海量商品与商圈高效匹配的算法](https://mp.weixin.qq.com/s/2B-VJ2xgwxrmsSkE6zuoPA)
[Geohash边界分形与拟合，让你的边界纵享丝滑](https://mp.weixin.qq.com/s/IN1L2-Pp9o-3LgXHAo6F7w)
[基于Geohash算法切分OID4点码](https://mp.weixin.qq.com/s/N7wJ9uqSWwgUSj6rr_FKSQ)
[Elasticsearch 在地理信息空间索引的探索和演进](https://mp.weixin.qq.com/s/y33FQjFN-f58h1_TIwgMAw)
[Redis(6)——GeoHash查找附近的人](https://mp.weixin.qq.com/s/wALOAK9mewQOyajTaSqGUw)
[Redis 到底是怎么实现“附近的人”这个功能的？](https://mp.weixin.qq.com/s/2uSr2YOjtLbUdHI01qc4rw)
[是什么能让 APP 快速精准定位到我们的位置？](https://mp.weixin.qq.com/s/KqCxb24FoIge9AropiSzXg)


- http://geohash.co/












![](http://img.blog.csdn.net/20171026101315516?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvU3VubnlZb29uYQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)


POI: 116.615,40.054
北京首都国际机场3号航站楼C区 116.614989,40.054538


(1) 10米

40.0555 116.615

40.0554 116.615

wx4gveuknqqk

wx4gveu7w7y2

前缀为7

(2) 100米

40.054 116.615
40.055 116.615

wx4gves7qqy2
wx4gveu3q3nq

前缀为6

(3) 1000米
40.04 116.615
40.05 116.615

wx4gv9h3ykyr
wx4gvduknmn7

前缀为5

(4) 10000米
40.1 116.615
40.0 116.615

wx4ujeurqmy3
wx4gt9u2ykqq

前缀为3







测试:

用户A:116.591366,40.071987      wx4gu
用户B:116.591967,40.107577      wx4uh
T1航站楼:116.587847,40.081313   wx4uh

A-T距离: 1078米
B-T距离: 2937米
